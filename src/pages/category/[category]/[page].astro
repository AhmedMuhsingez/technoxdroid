---
import BaseLayout from '@/layouts/BaseLayout'
import ListPosts from '@/components/ListPosts'
import ListCategories from '@/components/ListCategories'
import TitlePage from '@/components/TitlePage'
import { siteConfig } from '@/data/site.config'
import Pagination from '@/components/Pagination'
import { fetchArticles, fetchCategories } from 'src/utils/fetchApiData'

export const prerender = true

export async function getStaticPaths({ paginate }: any) {
	const categoriesData = await fetchCategories()

	const allArticles = (await fetchArticles(1, 6)).data.map((article) => {
		return article
	})

	return categoriesData.data.flatMap((category) => {
		const filteredArticles = allArticles.filter(
			//Filter all articles, WHERE ()...
			(article) => article.attributes.category.data.attributes.name === category.attributes.name
		)

		return paginate(filteredArticles, {
			params: {
				category: category.attributes.slug
			},
			pageSize: siteConfig.paginationSize,
			props: {
				categoryName: category.attributes.name,
				filteredArticles: filteredArticles,
				allArticles: allArticles
			}
		})
	})
}
const params = Astro.params
const { ...props } = Astro.props
const { page } = Astro.props

//This is the component for each page of the categories in the main page
---

<BaseLayout title={props.categoryName}>
	<TitlePage title={props.categoryName} />
	<ListCategories activeCategory={params.category} />
	<ListPosts filteredArticles={props.filteredArticles} />

	<Pagination page={page} />
</BaseLayout>
